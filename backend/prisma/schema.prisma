// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL") // Add this line!
}

/// ENUMS remain the same
enum AnimalType {
  PIG
  CATTLE
}

enum FeedCategory {
  STARTER
  GROWER
  FINISHER
  GESTATION
  LACTATING
}

enum OrderStatus {
  PENDING
  CONFIRMED
  DISPATCHED
  DELIVERED
  CANCELLED
}

enum PaymentMethod {
  CASH
  CREDIT
  ONLINE
}

enum DiscountType {
  FLAT
  PERCENTAGE
}

enum StockTransactionType {
  IN
  OUT
  ADJUSTMENT
}

enum FinishedStockTxnType {
  PRODUCTION_IN
  SALE_OUT
  ADJUSTMENT
}

// --------------------- MODELS WITH UUID IDs ------------------------

model Customer {
  id        String   @id @default(uuid())
  name      String
  phone     String   @unique
  address   String?
  orders    Order[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AdminUser {
  id           String   @id @default(uuid())
  name         String
  email        String   @unique
  phone        String?
  role         String
  passwordHash String
  orders       Order[]
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

// ----------------- FEED PRODUCT -------------------

model FeedProduct {
  id           String       @id @default(uuid())
  animalType   AnimalType
  feedType     FeedCategory
  name         String
  unit         String
  unitSize     Int
  pricePerUnit Float
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  orderItems OrderItem[]
  batches    ProductionBatch[]
  stock      FinishedFeedStock?
  stockTxns  FinishedFeedStockTransaction[]
}

// ----------------------- ORDER ------------------------

model Order {
  id            String        @id @default(uuid())
  customerId    String
  adminUserId   String
  orderStatus   OrderStatus   @default(PENDING)
  paymentMethod PaymentMethod
  totalAmount   Float
  discountType  DiscountType?
  discountValue Float?
  finalAmount   Float
  deliveryDate  DateTime?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  customer  Customer                       @relation(fields: [customerId], references: [id])
  adminUser AdminUser                      @relation(fields: [adminUserId], references: [id])
  items     OrderItem[]
  payments  Payment[]
  stockTxns FinishedFeedStockTransaction[]
}

model OrderItem {
  id            String   @id @default(uuid())
  orderId       String
  feedProductId String
  quantity      Int
  pricePerUnit  Float
  subtotal      Float
  createdAt     DateTime @default(now())

  order       Order       @relation(fields: [orderId], references: [id])
  feedProduct FeedProduct @relation(fields: [feedProductId], references: [id])
}

// ------------------ PAYMENTS ------------------

model Payment {
  id            String        @id @default(uuid())
  orderId       String
  amountPaid    Float
  paymentDate   DateTime      @default(now())
  paymentMethod PaymentMethod

  order Order @relation(fields: [orderId], references: [id])
}

model Expense {
  id          String   @id @default(uuid())
  category    String
  amount      Float
  note        String?
  expenseDate DateTime
  createdAt   DateTime @default(now())
}

// ------------------ RAW MATERIAL --------------------

model RawMaterial {
  id        String   @id @default(uuid())
  name      String
  unit      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  stockTxns RawMaterialStockTransaction[]
  batchUses ProductionBatchMaterial[]
}

model RawMaterialStockTransaction {
  id            String               @id @default(uuid())
  rawMaterialId String
  type          StockTransactionType
  quantity      Float
  referenceType String?
  referenceId   String?
  createdAt     DateTime             @default(now())

  rawMaterial RawMaterial @relation(fields: [rawMaterialId], references: [id])
}

// --------------- FINISHED FEED STOCK ---------------

model FinishedFeedStock {
  id                String   @id @default(uuid())
  feedProductId     String   @unique
  quantityAvailable Float
  updatedAt         DateTime @updatedAt

  feedProduct FeedProduct @relation(fields: [feedProductId], references: [id])
}

model FinishedFeedStockTransaction {
  id                String               @id @default(uuid())
  feedProductId     String
  type              FinishedStockTxnType
  quantity          Float
  orderId           String?
  productionBatchId String?
  createdAt         DateTime             @default(now())

  feedProduct     FeedProduct      @relation(fields: [feedProductId], references: [id])
  order           Order?           @relation(fields: [orderId], references: [id])
  productionBatch ProductionBatch? @relation(fields: [productionBatchId], references: [id])
}

// ------------------- PRODUCTION ------------------------

model ProductionBatch {
  id               String   @id @default(uuid())
  feedProductId    String
  batchNumber      String
  producedQuantity Float
  productionDate   DateTime
  createdAt        DateTime @default(now())

  feedProduct FeedProduct                    @relation(fields: [feedProductId], references: [id])
  materials   ProductionBatchMaterial[]
  stockTxns   FinishedFeedStockTransaction[]
}

model ProductionBatchMaterial {
  id            String @id @default(uuid())
  batchId       String
  rawMaterialId String
  quantityUsed  Float

  batch       ProductionBatch @relation(fields: [batchId], references: [id])
  rawMaterial RawMaterial     @relation(fields: [rawMaterialId], references: [id])
}
